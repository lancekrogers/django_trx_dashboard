{% extends "base.html" %}

{% block title %}SSE Demo - Multi-Chain Portfolio{% endblock %}

{% block content %}
<div class="px-4 sm:px-0">
    <h2 class="text-2xl font-bold mb-4">Server-Sent Events Demo</h2>
    
    <!-- SSE Connection Status -->
    <div class="mb-4 p-4 bg-white rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-2">Connection Status</h3>
        <div id="connection-status" class="text-gray-600">
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                Disconnected
            </span>
        </div>
    </div>
    
    <!-- Real-time Portfolio Value -->
    <div class="mb-4 p-4 bg-white rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-2">Real-time Portfolio Value</h3>
        <div class="text-3xl font-bold text-gray-900">
            $<span id="demo-portfolio-value">0.00</span>
        </div>
        <div class="text-sm text-gray-500 mt-1">
            Last updated: <span id="demo-last-updated">Never</span>
        </div>
    </div>
    
    <!-- Event Log -->
    <div class="mb-4 p-4 bg-white rounded-lg shadow">
        <h3 class="text-lg font-semibold mb-2">Event Log</h3>
        <div id="event-log" class="space-y-1 max-h-60 overflow-y-auto text-sm font-mono">
            <div class="text-gray-500">Waiting for events...</div>
        </div>
    </div>
    
    <!-- SSE Container -->
    <div hx-ext="sse" 
         sse-connect="/api/v1/portfolio/stream"
         class="hidden">
        
        <!-- Portfolio Update Handler -->
        <div sse-swap="portfolio-update"></div>
        
        <!-- Error Handler -->
        <div sse-swap="error"></div>
    </div>
</div>

<script>
    let eventCount = 0;
    const maxLogEntries = 50;
    
    // Update connection status
    function updateConnectionStatus(connected) {
        const statusEl = document.getElementById('connection-status');
        if (connected) {
            statusEl.innerHTML = `
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-1.5 animate-pulse"></span>
                    Connected
                </span>
            `;
        } else {
            statusEl.innerHTML = `
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                    <span class="w-2 h-2 bg-red-500 rounded-full mr-1.5"></span>
                    Disconnected
                </span>
            `;
        }
    }
    
    // Add event to log
    function addToEventLog(type, data) {
        const logEl = document.getElementById('event-log');
        const timestamp = new Date().toLocaleTimeString();
        const entry = document.createElement('div');
        entry.className = type === 'error' ? 'text-red-600' : 'text-gray-700';
        entry.textContent = `[${timestamp}] ${type}: ${JSON.stringify(data)}`;
        
        // Remove "waiting" message if it exists
        const waitingMsg = logEl.querySelector('.text-gray-500');
        if (waitingMsg) {
            waitingMsg.remove();
        }
        
        // Add new entry at the top
        logEl.insertBefore(entry, logEl.firstChild);
        
        // Keep only the last N entries
        while (logEl.children.length > maxLogEntries) {
            logEl.removeChild(logEl.lastChild);
        }
        
        eventCount++;
    }
    
    // Handle portfolio updates
    document.body.addEventListener('sse:portfolio-update', function(evt) {
        const data = JSON.parse(evt.detail.data);
        
        // Update portfolio value
        document.getElementById('demo-portfolio-value').textContent = data.total_value_usd.toFixed(2);
        
        // Update last updated time
        const now = new Date();
        document.getElementById('demo-last-updated').textContent = now.toLocaleTimeString();
        
        // Add to event log
        addToEventLog('portfolio-update', {
            value: data.total_value_usd,
            change: data.change_24h
        });
    });
    
    // Handle errors
    document.body.addEventListener('sse:error', function(evt) {
        const data = JSON.parse(evt.detail.data);
        addToEventLog('error', data);
    });
    
    // Handle connection events
    document.body.addEventListener('htmx:sseOpen', function(evt) {
        console.log('SSE Demo: Connected');
        updateConnectionStatus(true);
        addToEventLog('connection', { status: 'opened' });
    });
    
    document.body.addEventListener('htmx:sseClose', function(evt) {
        console.log('SSE Demo: Disconnected');
        updateConnectionStatus(false);
        addToEventLog('connection', { status: 'closed' });
    });
    
    document.body.addEventListener('htmx:sseError', function(evt) {
        console.error('SSE Demo: Error', evt);
        updateConnectionStatus(false);
        addToEventLog('connection', { status: 'error', detail: evt.detail });
    });
</script>
{% endblock %}